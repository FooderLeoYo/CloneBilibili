# 项目实现的功能

## 目录

[index](#jump1)

[search](#jump2)

[space](#jump3)

[channel](#jump4)

[ranking](#jump5)

[live](#jump6)

[video](#jump7)

[switcher](#jump8)

[tabBar](#jump9)

[drawer](#jump10)

[login](#jump11)

[toast](#jump12)

---	

<span id="jump1"></span>

## index

### header根据登录状态改变

- 若未登录，header右侧显示登录按钮

- 若已登录，则显示（官网真实的）个人头像，点击可进入个人空间

---

<span id="jump2"></span>

## search

大家都在搜

历史记录

输入时实时搜索建议

点击up名进入其空间

---

<span id="jump3"></span>

## space

---

### 登录鉴权

- 若未登录而是通过在地址栏输入"/space"进入的，则跳转到登录页面

### 历史记录

- 包含视频、直播记录

- 观看时间进行分类

- 显示观看时所使用的终端类型

- 直播记录显示当前播主是否在播

### UP主空间

<span id="jump4"></span>

## channel

- 长度够的情况下，一级Tab点击后，激活项总在第二个
 
- 二级tab为推荐时显示各分类的4个热门视频，点击排行榜进入当前一级分类的排行榜
 
- 二级tab为具体分类时显示当前分类的4个热门视频及最新视频，拉到底点击加载更多
 
- 推荐页中，点击各二级分类的查看更多可进入对应二级分类，tab也会相应变化

---

<span id="jump5"></span>

## ranking

点击up名字进入其空间

---

<span id="jump6"></span>

## live

首页各个分类的4个推荐，点击“进去看看”进入对应分区

二级tab进入对应分区

互动聊天区

---

<span id="jump7"></span>

## video

### 播放记录

- 进入一个视频、切换到另一个视频、退出VideoPage均会进行记录当前进度

- 播放记录会被记录到官方后台，可在B站官方WEB端、APP的历史记录中查到

- 播放记录内容包括所观看的视频、观看进度、何时观看、观看时所使用的平台

### 视频简介

视频上传时间会分被重定义为今天、昨天、前天等

点击up主名字进入其空间

点击箭头展开详情，箭头有动画

详情中有面包屑导航

### tab栏

滑动式切换

推荐列表、评论区中的用户头像和名字也是可以点的

### player

#### 上次播放位置

记录上次跳转位置

提示是否跳转

一段时间后消失

#### 弹幕

#### controls按钮点击时会变色

#### SpeedBtn

SpeedBar中当前速度为粉红色

点击SpeedBtn后显示SpeedBar并隐藏其他按钮，选择速度后SpeedBar隐藏

中间会显示当前速度，一段时间后自动隐藏

如果当前是暂停则显示左边白色PlayBtn，如果是播放则什么都不显示

ControlBar的SpeedBtn会变成当前速度对应的图标

SpeedBar一段时间无操作的话，会逐渐消失

#### 进度条

自定义了进度条及按钮图标，已播放部分的进度为粉红色

拖拽、点击均可改变播放位置

拖拽、点击结束后，会清理之前的弹幕，并加载当前时点弹幕

#### 弹幕

可通过ControlBar的按钮控制打开或关闭弹幕

#### 屏幕手势滑动调节

##### 屏幕滑动调节进度

左右滑动调节进度

手势调节时controlsBar会一直显示，其中的进度条、当前时间也会跟随手势一起变化

手势结束后，controlsBar会显示，一段时间后隐藏

##### 屏幕滑动调节音量

当手指在视频右半区域上下滑动时，可调节音量，中间会显示当前音量条，一段时间后自动隐藏

手势调节音量时，controlsBar不会显示

#### 屏幕滑动调节亮度

当手指在视频坐半区域上下滑动时，可调节亮度，中间会显示当前亮度条，一段时间后自动隐藏

controlsBar不会显示

##### 防止误操作

当进入调节音量、调节亮度或调节进度中的一种后，直到手指离开，都不会进入另一个模式，哪怕手势方向比较偏

---

<span id="jump8"></span>

## switcher

可复用，不限slide个数

拖拽、回弹效果

防晃动

记忆上次位置

父组件可拿到当前Index

---

<span id="jump9"></span>

## tabBar

### 功能

- 切换后的滑动动画

- 保证当前tab总在第二个位置，哪怕是从drawer中点取的

- 可拖动，拖到头不会继续被拖动

- 可选择是否需要下划线，下划线切换时有滑动动画

### 切换后的滑动动画

#### 尝试采用scroll api

移动可以通过scrollLeft或scrollTo实现,但由于其为web api而非css,transition无法对其奏效,只能使用递归或定时器模拟动画

但该api最大的问题是每次滚动均从头滚动，就会产生tabBar先回到最左边再向右移动的糟糕的动画效果

#### 改用translate3d

为tabBar添加slideAni类，为动画设置延时，并通过定时器在延时结束后取消slideAni类，以免影响手指拖拽时的效果

移动的目标位置为减去前一个tab宽度的位置，使得在tabBar长度允许的情况下curTab总在第二个位置

还考虑了宽屏适配，内容未铺满屏幕的情况：通过计算得到disBetwTarTabAndWrap，作为target tab距离内容边界的距离，而不是简单的使用target tab距离浏览器窗口的距离

### 拖到头后会继续被拖动

#### 问题

放弃scroll api改用translate3d后,tabbar拖到头后会继续被拖动,导致tabbar脱离边界

#### 解决办法

通过判断条件：

```javascript
tarPosition < this.maxTarPosition
```
使得如果一个拖动将使tabBar将被拖到头，则只能拖动不使得tabBar脱离边界的最大距离

由于没有offsetRight这个api,故只能变相用另外几个属性相减求offsetRight

### 下划线滑动动画

用一个span做的下划线

通过控制该span的style.left和style.width，可实现切换时下划线滑动，切换后长度变为当前tab的长度

---	

<span id="jump10"></span>

## drawer

拉开有遮盖层

遮盖层展开时，页面不能操作，只能点选头部

---	

<span id="jump11"></span>

## login

- 人机验证

  - 短信登录获取验证码及密码登录点击登录前，会进行人机验证

  - 等待人机验证加载时，会有提示及遮盖

- 短信登录

  - 选择地区后自动补充区号

  - 验证手机格式，格式错误会有toast提示，格式正确才能“获取短信”
  
  - 获取短信后60s才能再次发送

  - 验证手机格式及验证码格式，均正确后“验证登录”按钮才可用

  - 会有toast提示后台验证验证信息

- 密码登录

  - 验证账号格式及密码格式，均正确后登录按钮才可用

  - 点击密码框时，图片会切换成闭眼

  - 等待登录时，会有提示及遮盖

### 遇到的困难

#### 获取后台返回的cookie值

后台的返回数据通过response headers中的set-cookie，来为客户端设置登录cookie

如果直接将response整体返回给客户端，客户端不能执行set-cookie。必须在express router中调用setHeader单独设置headers，因此需要从后台response中取出cookie

由于响应头数据类型为[Symbol(Response internals)]，不能直接通过“.”取出响应数据data中的目标值，只能通过data.headers.get('set-cookie')来取

拿到set-cookie字符串后，再通过indexOf和substring方法分别依次从set-cookie字符串中截取出4个cookie

#### 客户端设置cookie

##### 请求和响应的headers的相关设置

main端fetch时需设置：

```javascript
credentials: "include",
```

api端需设置：

```javascript
res.header("Access-Control-Allow-Credentials", true);
```

##### 跨域cookie

原始cookie中的Domain均为B站域名，因其与本项目域名不一致形成跨域，会被浏览器拦截而无法成功设置

解决方法是通过replace方法，去除原始cookie中的Domain，这样Domain就会被默认设置为请求域名

---

<span id="jump12"></span>

## toast

